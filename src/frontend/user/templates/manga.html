{% extends "base.html" %}

{% block content %}
<main>
    <link rel="stylesheet" href="/static/css/manga.css">
    <div id="info">
        <div id="cover">
            <!-- Постер добавляем сразу, но с lazy -->
            <img src="{{ manga.poster }}" alt="{{ manga.title }}" loading="lazy">
        </div>
        <h1>{{ manga.title }}</h1>
        <a href="{{ manga.url }}">Оригинал</a>
    </div>
    <div id="info-manga">
        <div class="tags">
            {% if manga.genres %}
            <div class="tag">
                <h2>Жанры</h2>
                {% for genre in manga.genres %}
                    <a href="/manga/tags/{{ genre.id }}">{{ genre.name }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if manga.author %}
            <div class="tag">
                <h2>Автор</h2>
                <a href="/manga/author/{{ manga.author.id }}">{{ manga.author.name }}</a>
            </div>
            {% endif %}

            {% if manga.language %}
            <div class="tag">
                <h2>Язык</h2>
                <a href="/manga/language/{{ manga.language.id }}">{{ manga.language.name }}</a>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="gallery">
        <h2>Галлерея</h2>
        {% for image in manga.gallery %}
        <div class="container-gallery">
            <!-- Изображения галереи с ленивой загрузкой -->
            <img src="/static/images/placeholder.jpg" 
                data-src="{{ image }}" 
                alt="{{ manga.title }}" 
                class="lazy"
                loading="lazy"
                width="1000"
                height="1400">
        </div>
        {% endfor %}
    </div>
</main>

<script>
// Модальное окно для галереи
document.addEventListener('DOMContentLoaded', function() {
    const galleryImages = document.querySelectorAll('.container-gallery img');
    const modal = document.createElement('div');
    const modalContent = document.createElement('img');
    const closeBtn = document.createElement('button');
    const prevBtn = document.createElement('button');
    const nextBtn = document.createElement('button');
    const counter = document.createElement('div');
    
    let currentImageIndex = 0;
    
    // Создаем модальное окно
    modal.className = 'modal';
    modalContent.className = 'modal-content';
    closeBtn.className = 'close-modal';
    closeBtn.innerHTML = '&times;';
    prevBtn.className = 'nav-btn prev-btn';
    prevBtn.innerHTML = '&#10094;';
    nextBtn.className = 'nav-btn next-btn';
    nextBtn.innerHTML = '&#10095;';
    counter.className = 'modal-counter';
    
    // Добавляем элементы в модальное окно
    const controls = document.createElement('div');
    controls.className = 'modal-controls';
    controls.appendChild(closeBtn);
    modal.appendChild(modalContent);
    modal.appendChild(controls);
    modal.appendChild(prevBtn);
    modal.appendChild(nextBtn);
    modal.appendChild(counter);
    document.body.appendChild(modal);
    
    // Функция для открытия модального окна
    function openModal(index) {
        currentImageIndex = index;
        updateModalImage();
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Предзагружаем соседние изображения для модального окна
        preloadAdjacentImages(index);
    }
    
    // Предзагрузка соседних изображений
    function preloadAdjacentImages(currentIndex) {
        const indices = [
            (currentIndex - 1 + galleryImages.length) % galleryImages.length,
            (currentIndex + 1) % galleryImages.length
        ];
        
        indices.forEach(idx => {
            const img = new Image();
            const src = galleryImages[idx].getAttribute('data-src') || galleryImages[idx].src;
            img.src = src;
        });
    }
    
    // Функция для обновления изображения в модальном окне
    function updateModalImage() {
        // Используем data-src если есть, иначе обычный src
        const lazyImg = galleryImages[currentImageIndex];
        const imageSrc = lazyImg.getAttribute('data-src') || lazyImg.src;
        
        modalContent.src = imageSrc;
        modalContent.alt = lazyImg.alt;
        counter.textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;
        
        // Если было lazy-изображение, загружаем оригинал
        if (lazyImg.getAttribute('data-src')) {
            lazyImg.src = imageSrc;
            lazyImg.removeAttribute('data-src');
            lazyImg.classList.remove('lazy');
        }
    }
    
    // Закрытие модального окна
    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Переключение между изображениями
    function prevImage() {
        currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
        updateModalImage();
        preloadAdjacentImages(currentImageIndex);
    }
    
    function nextImage() {
        currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
        updateModalImage();
        preloadAdjacentImages(currentImageIndex);
    }
    
    // Добавляем обработчики событий для каждого изображения
    galleryImages.forEach((img, index) => {
        img.style.cursor = 'pointer';
        img.addEventListener('click', () => openModal(index));
    });
    
    // Обработчики событий для элементов управления
    closeBtn.addEventListener('click', closeModal);
    prevBtn.addEventListener('click', prevImage);
    nextBtn.addEventListener('click', nextImage);
    
    // Закрытие по клику на фон
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Закрытие по клавише ESC
    document.addEventListener('keydown', function(e) {
        if (modal.style.display === 'flex') {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft') prevImage();
            if (e.key === 'ArrowRight') nextImage();
        }
    });
    
    // Добавляем CSS для placeholder
    const style = document.createElement('style');
    style.textContent = `
        img.lazy {
            background: #f0f0f0;
            min-height: 200px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        img.lazy.loaded {
            opacity: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
    `;
    document.head.appendChild(style);
});
</script>

{% endblock %}